
set(BOOTLOADER_SRC ${CMAKE_CURRENT_LIST_DIR}/bootloader.asm)
set(BOOTLOADER_BIN ${CMAKE_CURRENT_BINARY_DIR}/bootloader.bin)
set(BOOTLOADER_LST ${CMAKE_CURRENT_BINARY_DIR}/bootloader.lst)
set(POSTPROCESS_SCRIPT ${CMAKE_CURRENT_LIST_DIR}/postprocess-bootloader.py)
get_target_property(common_asm_inc_dir common_asm INTERFACE_INCLUDE_DIRECTORIES)

add_custom_command(OUTPUT ${BOOTLOADER_BIN} ${BOOTLOADER_LST}
	COMMAND nasm -Wall -I ${CMAKE_CURRENT_LIST_DIR} -I ${common_asm_inc_dir} -l ${BOOTLOADER_LST} -D CODE_START_OFFSET=${BOOTLOADER_CODE_START_OFFSET} -f bin -o ${BOOTLOADER_BIN} ${BOOTLOADER_SRC}
	COMMAND ${POSTPROCESS_SCRIPT} ${BOOTLOADER_BIN} ${BOOTLOADER_CODE_START_OFFSET} ${BOOTLOADER_LST}
    DEPENDS ${BOOTLOADER_SRC} ${POSTPROCESS_SCRIPT}
    )

add_custom_target(bootloader
    DEPENDS ${BOOTLOADER_BIN})

set(BOOTLOADER_BIN ${BOOTLOADER_BIN} PARENT_SCOPE)
